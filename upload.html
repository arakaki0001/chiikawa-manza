<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿æ›´æ–° | ã¡ã„ã‹ã‚åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="inventory_data.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            color: var(--text-light);
            text-decoration: none;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .upload-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .upload-card h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .drop-zone {
            border: 3px dashed var(--primary-light);
            border-radius: var(--radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            background: var(--bg-main);
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .drop-zone .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .drop-zone p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .drop-zone .filename {
            display: none;
            font-weight: 600;
            color: var(--primary);
            margin-top: 1rem;
        }

        .drop-zone.has-file .filename {
            display: block;
        }

        .upload-btn {
            display: block;
            width: 100%;
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .upload-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status-info {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }

        .status-info.success {
            background: #D4EDDA;
            color: #155724;
        }

        .status-info.error {
            background: #F8D7DA;
            color: #721C24;
        }

        .status-info.info {
            background: var(--primary-light);
            color: var(--text-primary);
        }

        .last-update {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 1rem;
        }

        .file-input {
            display: none;
        }

        .data-preview {
            margin-top: 1.5rem;
            max-height: 300px;
            overflow: auto;
            font-size: 0.85rem;
        }

        .data-preview table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-preview th,
        .data-preview td {
            padding: 0.5rem;
            border: 1px solid var(--primary-light);
            text-align: left;
        }

        .data-preview th {
            background: var(--primary-light);
            position: sticky;
            top: 0;
        }

        .instructions {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
        }

        .instructions h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .instructions ol {
            padding-left: 1.5rem;
            color: var(--text-secondary);
        }

        .instructions li {
            margin-bottom: 0.75rem;
        }

        .instructions code {
            background: var(--primary-light);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .upload-card {
                padding: 1.25rem;
            }

            .upload-card h2 {
                font-size: 1.1rem;
            }

            .drop-zone {
                padding: 2rem 1rem;
            }

            .drop-zone .icon {
                font-size: 2.5rem;
            }

            .drop-zone p {
                font-size: 0.9rem;
            }

            .instructions {
                padding: 1.25rem;
            }

            .instructions ol {
                padding-left: 1.25rem;
            }

            .data-preview {
                max-height: 200px;
            }

            .data-preview th,
            .data-preview td {
                padding: 0.4rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">ğŸ“¤</span>
                <div>
                    <h1>ãƒ‡ãƒ¼ã‚¿æ›´æ–°</h1>
                    <span class="logo-subtitle">ä¸‡åº§æ¯›ã‚·ãƒ§ãƒƒãƒ—</span>
                </div>
            </div>
            <div class="header-info">
                <a href="index.html" class="nav-link">ğŸ“¦ åœ¨åº«ç®¡ç†</a>
                <a href="sales.html" class="nav-link">ğŸ“ˆ å£²ä¸Šæ¨ç§»</a>
                <a href="forecast.html" class="nav-link">ğŸ”® åœ¨åº«äºˆæ¸¬</a>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main">
        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="upload-section">
            <!-- å£²ä¸ŠCSV -->
            <div class="upload-card">
                <h2>ğŸ“Š å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼ˆCSVï¼‰</h2>
                <div class="drop-zone" id="salesDropZone">
                    <div class="icon">ğŸ“</div>
                    <p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p>ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                    <span class="filename" id="salesFilename"></span>
                </div>
                <input type="file" class="file-input" id="salesFileInput" accept=".csv">
                <button class="upload-btn" id="salesUploadBtn" disabled>ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>
                <div class="status-info info" id="salesStatus">
                    <span id="salesLastUpdate">æœ€çµ‚æ›´æ–°: æœªèª­ã¿è¾¼ã¿</span>
                </div>
                <div class="data-preview" id="salesPreview"></div>
            </div>

            <!-- æ£šå¸è¡¨Excel -->
            <div class="upload-card">
                <h2>ğŸ“‹ æ£šå¸è¡¨ï¼ˆExcelï¼‰ã‹ã‚‰æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ</h2>
                <div class="drop-zone" id="inventoryDropZone">
                    <div class="icon">ğŸ“</div>
                    <p>Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p>ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                    <span class="filename" id="inventoryFilename"></span>
                </div>
                <input type="file" class="file-input" id="inventoryFileInput" accept=".xlsx,.xls">
                <button class="upload-btn" id="inventoryUploadBtn" disabled>æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <div class="status-info info" id="inventoryStatus">
                    <span id="inventoryLastUpdate">æœ€çµ‚æ›´æ–°: æœªèª­ã¿è¾¼ã¿</span>
                </div>
                <div class="data-preview" id="inventoryPreview"></div>
            </div>
        </section>

        <!-- ä½¿ã„æ–¹ -->
        <section class="instructions">
            <h3>ğŸ“– ä½¿ã„æ–¹</h3>
            <ol>
                <li>Squareã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸå£²ä¸ŠCSVãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ<code>å•†å“-YYYY-MM-DD.csv</code>ï¼‰ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</li>
                <li>æœ€æ–°ã®æ£šå¸è¡¨Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</li>
                <li>ã€Œãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸ <code>inventory_data.js</code> ã§ã€å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãä¿å­˜ã—ã¦ãã ã•ã„</li>
            </ol>
            <div class="status-info info" style="margin-top:1rem;">
                ğŸ’¡ <strong>ãƒ’ãƒ³ãƒˆ:</strong> é€±ã«1å›ç¨‹åº¦ã€æœ€æ–°ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€åœ¨åº«äºˆæ¸¬ã®ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚
            </div>
        </section>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <p>ğŸ¾ ã¡ã„ã‹ã‚åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.0 | ä¸‡åº§æ¯›ã‚·ãƒ§ãƒƒãƒ—</p>
    </footer>

    <script>
        // å£²ä¸ŠCSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        let salesFile = null;
        let inventoryFile = null;

        document.addEventListener('DOMContentLoaded', () => {
            setupDropZone('salesDropZone', 'salesFileInput', 'salesFilename', 'salesUploadBtn', (file) => { salesFile = file; });
            setupDropZone('inventoryDropZone', 'inventoryFileInput', 'inventoryFilename', 'inventoryUploadBtn', (file) => { inventoryFile = file; });

            document.getElementById('salesUploadBtn').addEventListener('click', processSalesCSV);
            document.getElementById('inventoryUploadBtn').addEventListener('click', processInventoryExcel);

            loadLastUpdateTimes();
        });

        function setupDropZone(zoneId, inputId, filenameId, btnId, onFileSelect) {
            const zone = document.getElementById(zoneId);
            const input = document.getElementById(inputId);
            const filename = document.getElementById(filenameId);
            const btn = document.getElementById(btnId);

            if (!zone || !input || !filename || !btn) return;

            zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    selectFile(file);
                }
            });

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectFile(file);
                }
            });

            function selectFile(file) {
                filename.textContent = 'ğŸ“„ ' + file.name;
                zone.classList.add('has-file');
                btn.disabled = false;
                onFileSelect(file);
            }
        }

        function processSalesCSV() {
            if (!salesFile) return;

            const status = document.getElementById('salesStatus');
            const preview = document.getElementById('salesPreview');

            if (!status || !preview) {
                console.error('DOM elements not found');
                return;
            }

            status.className = 'status-info info';
            status.innerHTML = 'â³ å‡¦ç†ä¸­...';

            // ã¾ãšUTF-8ã§è©¦ã—ã€å¤±æ•—ã—ãŸã‚‰Shift-JISã§å†è©¦è¡Œ
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let content = e.target.result;

                    // æ–‡å­—åŒ–ã‘ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°Shift-JISã§å†èª­ã¿è¾¼ã¿ï¼‰
                    if (!content.includes('æ—¥ä»˜') && !content.includes('å•†å“')) {
                        // Shift-JISã§å†è©¦è¡Œ
                        const reader2 = new FileReader();
                        reader2.onload = (e2) => {
                            parseCSVContent(e2.target.result, status, preview);
                        };
                        reader2.onerror = () => {
                            status.className = 'status-info error';
                            status.innerHTML = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                        };
                        reader2.readAsText(salesFile, 'Shift_JIS');
                        return;
                    }

                    parseCSVContent(content, status, preview);
                } catch (err) {
                    status.className = 'status-info error';
                    status.innerHTML = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
                }
            };
            reader.onerror = () => {
                status.className = 'status-info error';
                status.innerHTML = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            };
            reader.readAsText(salesFile, 'UTF-8');
        }

        function parseCSVContent(content, status, preview) {
            try {
                const lines = content.split(/\r?\n/).filter(line => line.trim());

                if (lines.length < 2) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã¾ã™');
                }

                const headers = lines[0].split('\t');

                // æ—¥ä»˜åˆ—ã¨ç´”å£²ä¸Šé«˜åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¢ã™
                let dateIndex = 0;
                let salesIndex = 11; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

                for (let i = 0; i < headers.length; i++) {
                    if (headers[i].includes('æ—¥ä»˜')) dateIndex = i;
                    if (headers[i].includes('ç´”å£²ä¸Šé«˜')) salesIndex = i;
                }

                // æ–°ã—ã„CSVã‹ã‚‰æ—¥ä»˜ã¨å£²ä¸Šã‚’è§£æ
                const newDailySales = {};
                let validRows = 0;

                for (let i = 1; i < lines.length; i++) {
                    const fields = lines[i].split('\t');
                    const date = fields[dateIndex] || '';
                    const salesStr = (fields[salesIndex] || '').replace(/[Â¥,\"]/g, '');
                    const sales = parseInt(salesStr) || 0;

                    if (date && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        if (!newDailySales[date]) newDailySales[date] = 0;
                        newDailySales[date] += sales;
                        validRows++;
                    }
                }

                if (validRows === 0) {
                    throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }

                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                const existingData = localStorage.getItem('chiikawa_sales_data');
                let mergedSales = {};
                let addedDates = 0;
                let updatedDates = 0;

                if (existingData) {
                    mergedSales = JSON.parse(existingData);
                }

                // ãƒãƒ¼ã‚¸ï¼ˆæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã€é‡è¤‡ã¯æ–°ã—ã„æ–¹ã‚’å„ªå…ˆï¼‰
                const newDates = Object.keys(newDailySales);
                newDates.forEach(date => {
                    if (mergedSales[date] !== undefined) {
                        updatedDates++;
                    } else {
                        addedDates++;
                    }
                    mergedSales[date] = newDailySales[date];
                });

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('chiikawa_sales_data', JSON.stringify(mergedSales));
                localStorage.setItem('chiikawa_sales_updated', new Date().toISOString());

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆãƒãƒ¼ã‚¸å¾Œã®ãƒ‡ãƒ¼ã‚¿ï¼‰
                const sortedDates = Object.keys(mergedSales).sort().slice(-10);
                const totalDays = Object.keys(mergedSales).length;
                const totalSales = Object.values(mergedSales).reduce((a, b) => a + b, 0);

                preview.innerHTML = `
                    <table>
                        <thead><tr><th>æ—¥ä»˜</th><th>å£²ä¸Š</th></tr></thead>
                        <tbody>
                            ${sortedDates.map(d => `<tr><td>${d}</td><td>Â¥${mergedSales[d].toLocaleString()}</td></tr>`).join('')}
                        </tbody>
                    </table>
                    <p style="margin-top:1rem;color:var(--text-secondary);">
                        â€» ç›´è¿‘10æ—¥åˆ†ã‚’è¡¨ç¤º | å…¨${totalDays}æ—¥åˆ† | åˆè¨ˆ: Â¥${totalSales.toLocaleString()}
                    </p>
                `;

                status.className = 'status-info success';
                let message = `âœ… ${Object.keys(newDailySales).length}æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†`;
                if (updatedDates > 0) {
                    message += `ï¼ˆ${updatedDates}æ—¥æ›´æ–°, ${addedDates}æ—¥è¿½åŠ ï¼‰`;
                }
                status.innerHTML = message;

                loadLastUpdateTimes();
            } catch (err) {
                status.className = 'status-info error';
                status.innerHTML = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
            }
        }

        function processInventoryExcel() {
            if (!inventoryFile) return;

            const status = document.getElementById('inventoryStatus');
            const preview = document.getElementById('inventoryPreview');

            // inventoryDataãƒã‚§ãƒƒã‚¯
            if (typeof inventoryData === 'undefined') {
                status.className = 'status-info error';
                status.innerHTML = 'âŒ ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            if (!status || !preview) {
                console.error('DOM elements not found');
                return;
            }

            status.className = 'status-info info';
            status.innerHTML = 'â³ å‡¦ç†ä¸­...';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¨ã‚«ãƒ©ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç‰¹å®š
                    let headerRow = -1;
                    let colIndex = { jan: -1, stock: -1 };

                    for (let i = 0; i < json.length; i++) {
                        const row = json[i];
                        if (row && row.includes('JAN') && row.includes('åœ¨åº«æ•°')) {
                            headerRow = i;
                            row.forEach((col, idx) => {
                                if (col === 'JAN') colIndex.jan = idx;
                                if (col === 'åœ¨åº«æ•°') colIndex.stock = idx;
                            });
                            break;
                        }
                    }

                    if (headerRow === -1 || colIndex.jan === -1 || colIndex.stock === -1) {
                        throw new Error('JANã‚³ãƒ¼ãƒ‰åˆ—ã¾ãŸã¯åœ¨åº«æ•°åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }

                    // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼
                    const updatedInventory = JSON.parse(JSON.stringify(inventoryData));
                    let updateCount = 0;
                    const previewItems = [];
                    // æ—§å¤‰æ•°ï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ç”¨ãƒ€ãƒŸãƒ¼ï¼‰
                    const stockUpdates = {};

                    // Excelãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ã
                    for (let i = headerRow + 1; i < json.length; i++) {
                        const row = json[i];
                        if (row && row[colIndex.jan] && String(row[0]) !== 'åˆè¨ˆ') {
                            const jan = String(row[colIndex.jan]).trim();
                            const stock = parseInt(String(row[colIndex.stock]).replace(/,/g, '')) || 0;
                            // const name = row[colIndex.name] || 'ä¸æ˜ãªå•†å“'; // ä¸è¦

                            // JANã‚³ãƒ¼ãƒ‰ãŒä¸€è‡´ã™ã‚‹å•†å“ã‚’æ›´æ–°
                            const targetItem = updatedInventory.find(item => item.jan === jan);
                            if (targetItem) {
                                targetItem.stock = stock;
                                updateCount++;
                                if (previewItems.length < 10) {
                                    previewItems.push({ jan, name: targetItem.name, stock });
                                }
                            }
                        }
                    }

                    // æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ (inventory_data.js)
                    const fileContent = `// ã¡ã„ã‹ã‚åœ¨åº«ãƒ‡ãƒ¼ã‚¿\n// å•†å“ãƒã‚¹ã‚¿ + æ£šå¸è¡¨ãƒ‡ãƒ¼ã‚¿çµ±åˆ\n\nconst inventoryData = ${JSON.stringify(updatedInventory, null, 4)};\n\n// ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—\nconst categories = [...new Set(inventoryData.map(item => item.category))];\n`;

                    const blob = new Blob([fileContent], { type: 'text/javascript' });
                    const url = URL.createObjectURL(blob);

                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'inventory_data.js';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    preview.innerHTML = `
                        <div style="margin-bottom:1rem;padding:0.5rem;background:#E8F4FD;border:1px solid #B8E2F2;border-radius:8px;color:#0D6EFD;font-weight:600;">
                            â¬‡ï¸ inventory_data.js ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚<br>
                            ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ä¸Šæ›¸ãä¿å­˜ã—ã¦ãã ã•ã„ã€‚
                        </div>
                        <table>
                            <thead><tr><th>JAN</th><th>å•†å“å</th><th>æ›´æ–°å¾Œåœ¨åº«</th></tr></thead>
                            <tbody>
                                ${previewItems.map(item => `<tr><td>${item.jan}</td><td>${item.name}</td><td>${item.stock}</td></tr>`).join('')}
                            </tbody>
                        </table>
                        <p style="margin-top:1rem;color:var(--text-secondary);">â€» æ›´æ–°ã•ã‚ŒãŸå…ˆé ­10ä»¶ã‚’è¡¨ç¤ºï¼ˆå…¨${updateCount}ä»¶æ›´æ–°ï¼‰</p>
                    `;

                    status.className = 'status-info success';
                    status.innerHTML = `âœ… ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†ï¼ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã—ã¦ãã ã•ã„`;

                    // ä¸€å¿œãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                    localStorage.setItem('chiikawa_inventory_updated', new Date().toISOString());
                    loadLastUpdateTimes();
                } catch (err) {
                    status.className = 'status-info error';
                    status.innerHTML = 'âŒ æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message;
                    console.error(err);
                }
            };
            reader.onerror = () => {
                status.className = 'status-info error';
                status.innerHTML = 'âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            };
            reader.readAsArrayBuffer(inventoryFile);
        }

        function loadLastUpdateTimes() {
            const salesUpdated = localStorage.getItem('chiikawa_sales_updated');
            const inventoryUpdated = localStorage.getItem('chiikawa_inventory_updated');

            const salesLastUpdateEl = document.getElementById('salesLastUpdate');
            const inventoryLastUpdateEl = document.getElementById('inventoryLastUpdate');

            if (salesUpdated && salesLastUpdateEl) {
                const date = new Date(salesUpdated);
                salesLastUpdateEl.textContent =
                    `æœ€çµ‚æ›´æ–°: ${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP')}`;
            }

            if (inventoryUpdated && inventoryLastUpdateEl) {
                const date = new Date(inventoryUpdated);
                inventoryLastUpdateEl.textContent =
                    `æœ€çµ‚æ›´æ–°: ${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP')}`;
            }
        }
    </script>
</body>

</html>