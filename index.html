<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã¡ã„ã‹ã‚åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | ä¸‡åº§æ¯›ã‚·ãƒ§ãƒƒãƒ—</title>
  <meta name="description" content="ä¸‡åº§æ¯›ã‚·ãƒ§ãƒƒãƒ—ã®ã¡ã„ã‹ã‚å•†å“åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
    }

    .nav-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50px;
      color: white;
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .download-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .download-btn:hover {
      background: #7BC98F;
      transform: translateY(-2px);
    }

    .download-group {
      display: flex;
      gap: 0.5rem;
    }
  </style>
</head>

<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <span class="logo-icon">ğŸ§¸</span>
        <div>
          <h1>ã¡ã„ã‹ã‚åœ¨åº«ç®¡ç†</h1>
          <span class="logo-subtitle">ä¸‡åº§æ¯›ã‚·ãƒ§ãƒƒãƒ—</span>
        </div>
      </div>
      <div class="header-info">
        <a href="sales.html" class="nav-link">ğŸ“ˆ å£²ä¸Šæ¨ç§»</a>
        <a href="forecast.html" class="nav-link">ğŸ”® åœ¨åº«äºˆæ¸¬</a>
        <a href="upload.html" class="nav-link">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿æ›´æ–°</a>
      </div>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="main">
    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <section class="dashboard">
      <div class="stat-card total">
        <div class="stat-icon">ğŸ“¦</div>
        <div class="stat-label">ç™»éŒ²å•†å“æ•°</div>
        <div class="stat-value" id="totalProducts">-</div>
      </div>
      <div class="stat-card value">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-label">ç·åœ¨åº«é‡‘é¡ï¼ˆç¨è¾¼ï¼‰</div>
        <div class="stat-value" id="totalValue">-</div>
      </div>
      <div class="stat-card low">
        <div class="stat-icon">âš ï¸</div>
        <div class="stat-label">ä½åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ</div>
        <div class="stat-value" id="lowStockCount">-</div>
        <div class="stat-change">10å€‹ä»¥ä¸‹ã®å•†å“</div>
      </div>
      <div class="stat-card categories">
        <div class="stat-icon">ğŸ·ï¸</div>
        <div class="stat-label">ã‚«ãƒ†ã‚´ãƒªæ•°</div>
        <div class="stat-value" id="categoryCount">-</div>
      </div>
    </section>

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <section class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="å•†å“åã¾ãŸã¯JANã‚³ãƒ¼ãƒ‰ã§æ¤œç´¢...">
      </div>
      <div class="filter-group" id="categoryFilters">
        <!-- JavaScriptã§ç”Ÿæˆ -->
      </div>
      <div class="stock-filter">
        <label for="lowStockToggle">ä½åœ¨åº«ã®ã¿è¡¨ç¤º</label>
        <label class="toggle-switch">
          <input type="checkbox" id="lowStockToggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </section>

    <!-- å•†å“ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <section class="table-container">
      <div class="table-header">
        <h2 class="table-title">ğŸ“‹ å•†å“ä¸€è¦§</h2>
        <div style="display:flex;align-items:center;gap:1rem;">
          <span class="result-count" id="resultCount">-ä»¶ã‚’è¡¨ç¤º</span>
          <button class="history-btn" onclick="openHistoryModal()">ğŸ“‹ å…¥è·å±¥æ­´</button>
          <div class="download-group">
            <button class="download-btn" onclick="downloadCSV()">ğŸ“¥ CSV</button>
            <button class="download-btn" onclick="downloadExcel()">ğŸ“¥ Excel</button>
          </div>
        </div>
      </div>
      <table class="inventory-table">
        <thead>
          <tr>
            <th data-sort="id">No. <span class="sort-icon">â†•</span></th>
            <th data-sort="name">å•†å“å <span class="sort-icon">â†•</span></th>
            <th data-sort="category">ã‚«ãƒ†ã‚´ãƒª <span class="sort-icon">â†•</span></th>
            <th data-sort="stock">åœ¨åº«æ•° <span class="sort-icon">â†•</span></th>
            <th data-sort="costInTax">ä»•å…¥ä¾¡æ ¼ <span class="sort-icon">â†•</span></th>
            <th data-sort="priceInTax">å£²ä¾¡ <span class="sort-icon">â†•</span></th>
            <th>åœ¨åº«é‡‘é¡</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="8" class="loading">èª­ã¿è¾¼ã¿ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </section>
  </main>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <footer class="footer">
    <p>ğŸ¾ ã¡ã„ã‹ã‚åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v1.0 | ä¸‡åº§æ¯›ã‚·ãƒ§ãƒƒãƒ—</p>
  </footer>

  <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script src="inventory_data.js"></script>
  <script src="script.js"></script>
  <script>
    // æ£šå¸è¡¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
    function getFormattedDate() {
      const now = new Date();
      return `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥`;
    }

    function downloadCSV() {
      const headers = ['No.', 'JAN', 'å•†å“å', 'ã‚«ãƒ†ã‚´ãƒª', 'åœ¨åº«æ•°', 'ä»•å…¥ç¨è¾¼', 'å£²ä¾¡ç¨è¾¼', 'åœ¨åº«é‡‘é¡'];
      const rows = inventoryData.map(item => [
        item.id,
        item.jan,
        item.name,
        item.category,
        item.stock,
        item.costInTax,
        item.priceInTax,
        item.costInTax * item.stock
      ]);

      // BOMä»˜ãUTF-8
      const bom = '\uFEFF';
      const csvContent = bom + [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `æ£šå¸è¡¨_${getFormattedDate()}.csv`;
      link.click();
    }

    function downloadExcel() {
      // æœˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      openMonthSelectModal();
    }

    function openMonthSelectModal() {
      // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
      let modal = document.getElementById('monthSelectModal');
      if (!modal) {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;

        const modalHtml = `
          <div id="monthSelectModal" class="modal-overlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
            <div style="background:white;border-radius:16px;padding:0;width:90%;max-width:350px;box-shadow:0 20px 40px rgba(0,0,0,0.2);">
              <div style="display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid #eee;">
                <h3 style="margin:0;font-size:1.1rem;">ğŸ“… æ£šå¸è¡¨ã®æœˆã‚’é¸æŠ</h3>
                <button onclick="closeMonthSelectModal()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#888;">&times;</button>
              </div>
              <div style="padding:1.5rem;">
                <div style="display:flex;gap:0.75rem;margin-bottom:1rem;">
                  <div style="flex:1;">
                    <label style="display:block;font-size:0.85rem;color:#666;margin-bottom:0.5rem;">å¹´</label>
                    <select id="selectYear" style="width:100%;padding:0.75rem;border:2px solid #FFE4E9;border-radius:8px;font-size:1rem;">
                      <option value="${currentYear - 1}">${currentYear - 1}å¹´</option>
                      <option value="${currentYear}" selected>${currentYear}å¹´</option>
                    </select>
                  </div>
                  <div style="flex:1;">
                    <label style="display:block;font-size:0.85rem;color:#666;margin-bottom:0.5rem;">æœˆ</label>
                    <select id="selectMonth" style="width:100%;padding:0.75rem;border:2px solid #FFE4E9;border-radius:8px;font-size:1rem;">
                      ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(m =>
          `<option value="${m}" ${m === currentMonth ? 'selected' : ''}>${m}æœˆ</option>`
        ).join('')}
                    </select>
                  </div>
                </div>
                <p style="font-size:0.85rem;color:#888;margin:0 0 1rem;">æ£šå¸è¡¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹æœˆã§ã™</p>
              </div>
              <div style="display:flex;gap:0.75rem;padding:1rem 1.5rem;border-top:1px solid #eee;background:#f8f8f8;border-radius:0 0 16px 16px;">
                <button onclick="closeMonthSelectModal()" style="flex:1;padding:0.75rem;background:#e0e0e0;border:none;border-radius:50px;font-size:0.95rem;cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="executeExcelDownload()" style="flex:1;padding:0.75rem;background:#98D8AA;color:white;border:none;border-radius:50px;font-size:0.95rem;font-weight:600;cursor:pointer;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('monthSelectModal');
      }
      modal.style.display = 'flex';
    }

    function closeMonthSelectModal() {
      document.getElementById('monthSelectModal').style.display = 'none';
    }

    function executeExcelDownload() {
      const year = document.getElementById('selectYear').value;
      const month = document.getElementById('selectMonth').value;
      const monthStr = `${year}å¹´${month}æœˆ`;

      // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
      const headerRows = [
        ['ä¸‡åº§æ¯›ã‚·ãƒ§ãƒƒãƒ—æ£šå¸è¡¨'],
        [`æ£šå¸è¡¨ ${monthStr}`, '', '', 'æ ªå¼ä¼šç¤¾ãƒ©ã‚¯ã‚»ã‚¹ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³'],
        ['', '', '', 'ä½œæˆæ—¥', getFormattedDate()],
        []
      ];

      // ãƒ‡ãƒ¼ã‚¿ãƒ˜ãƒƒãƒ€ãƒ¼
      const dataHeaders = ['No.', 'JAN', 'å•†å“å', 'ã‚«ãƒ†ã‚´ãƒª', 'åœ¨åº«æ•°', 'ä»•å…¥ç¨è¾¼', 'å£²ä¾¡ç¨è¾¼', 'åœ¨åº«é‡‘é¡'];

      // ãƒ‡ãƒ¼ã‚¿è¡Œ
      const dataRows = inventoryData.map(item => [
        item.id,
        item.jan,
        item.name,
        item.category,
        item.stock,
        item.costInTax,
        item.priceInTax,
        item.costInTax * item.stock
      ]);

      // åˆè¨ˆè¡Œ
      const totalStock = inventoryData.reduce((sum, item) => sum + item.stock, 0);
      const totalValue = inventoryData.reduce((sum, item) => sum + (item.costInTax * item.stock), 0);
      const totalRow = ['', '', 'åˆè¨ˆ', '', totalStock, '', '', totalValue];

      // ã‚·ãƒ¼ãƒˆä½œæˆ
      const ws = XLSX.utils.aoa_to_sheet([
        ...headerRows,
        dataHeaders,
        ...dataRows,
        [],
        totalRow
      ]);

      // åˆ—å¹…è¨­å®š
      ws['!cols'] = [
        { wch: 5 },   // No.
        { wch: 15 },  // JAN
        { wch: 50 },  // å•†å“å
        { wch: 12 },  // ã‚«ãƒ†ã‚´ãƒª
        { wch: 8 },   // åœ¨åº«æ•°
        { wch: 10 },  // ä»•å…¥ç¨è¾¼
        { wch: 10 },  // å£²ä¾¡ç¨è¾¼
        { wch: 12 }   // åœ¨åº«é‡‘é¡
      ];

      // ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ä½œæˆ
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'æ£šå¸è¡¨');

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      XLSX.writeFile(wb, `æ£šå¸è¡¨_${monthStr}.xlsx`);

      closeMonthSelectModal();
    }
  </script>
</body>

</html>